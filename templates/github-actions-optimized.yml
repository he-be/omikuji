# AIé§†å‹•é–‹ç™ºæœ€é©åŒ– GitHub Actions CI/CD ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
# AUTOMATION_GUIDELINE.md + LESSONS_LEARNED.md ã®çŸ¥è¦‹ã‚’åæ˜ 
# 4å±¤æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ  + Cloudflare Workersçµ±ä¸€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

name: AI-Driven CI/CD Pipeline - Cloudflare Workers

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

# åŒæ™‚å®Ÿè¡Œåˆ¶å¾¡ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '20.x'
  CI: true

jobs:
  # ç¬¬1å±¤: é™çš„è§£æï¼ˆTypeScript + ESLint + Prettierï¼‰
  static-analysis:
    name: "Layer 1: Static Analysis"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: TypeScript Type Check
        run: npm run typecheck
      
      - name: ESLint Code Quality
        run: npm run lint
      
      - name: Prettier Format Check
        run: npm run format:check

  # ç¬¬2å±¤: å˜ä½“ãƒ†ã‚¹ãƒˆï¼ˆVitestï¼‰
  unit-tests:
    name: "Layer 2: Unit Tests"
    runs-on: ubuntu-latest
    needs: static-analysis
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run Vitest Unit Tests
        run: npm run test:unit
      
      - name: Generate Coverage Report
        run: npm run test:coverage
      
      # PRã¸ã®ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ
      - name: Coverage Report
        if: github.event_name == 'pull_request'
        uses: davelosert/vitest-coverage-report-action@v2
      
      # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: coverage/
          retention-days: 7

  # ç¬¬3å±¤: E2Eãƒ†ã‚¹ãƒˆï¼ˆPlaywrightï¼‰
  e2e-tests:
    name: "Layer 3: E2E Tests"
    runs-on: ubuntu-latest
    needs: unit-tests
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright browsers
        run: npx playwright install chromium
      
      - name: Run Playwright E2E Tests
        run: npm run test:e2e
        env:
          CI: true
      
      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  # Cloudflare Workers ãƒ“ãƒ«ãƒ‰æ¤œè¨¼
  build:
    name: "Build Verification"
    runs-on: ubuntu-latest
    needs: unit-tests
    timeout-minutes: 5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build Cloudflare Workers
        run: npm run build
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: dist/
          retention-days: 7

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: static-analysis
    timeout-minutes: 5
    continue-on-error: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

  # Cloudflare Workers ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
  deploy:
    name: Deploy to Cloudflare Workers
    runs-on: ubuntu-latest
    needs: [unit-tests, e2e-tests, build, security]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    timeout-minutes: 10
    
    environment:
      name: production
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build for Cloudflare Workers
        run: npm run build
      
      - name: Deploy to Cloudflare Workers
        id: deploy
        run: |
          npm run deploy
          echo "url=https://your-worker.your-subdomain.workers.dev" >> $GITHUB_OUTPUT
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
      
      - name: Verify deployment
        run: |
          sleep 10
          curl -f ${{ steps.deploy.outputs.url }} || exit 1

  # æˆåŠŸé€šçŸ¥
  notify-success:
    name: Notify Success
    runs-on: ubuntu-latest
    needs: [unit-tests, e2e-tests, build]
    if: success()
    
    steps:
      - name: Send success notification
        run: |
          echo "ğŸ¤– AI-Driven CI/CD Pipeline completed successfully!"
          echo "âœ… 4-Layer Verification System passed:"
          echo "   Layer 1: Static Analysis (TypeScript + ESLint + Prettier)"
          echo "   Layer 2: Unit Tests (Vitest)"
          echo "   Layer 3: E2E Tests (Playwright)"
          echo "   Layer 4: Quality Gates (Pre-commit hooks)"
          echo "ğŸš€ Ready for Cloudflare Workers deployment!"

# AIé§†å‹•é–‹ç™º 4å±¤æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ :
# static-analysis (Layer 1)
#   â”œâ”€â”€ unit-tests (Layer 2) â†’ e2e-tests (Layer 3) â†’ deploy (main only)
#   â”œâ”€â”€ build (parallel)
#   â””â”€â”€ security (parallel)
#
# ç‰¹å¾´:
# - AUTOMATION_GUIDELINE.md ã®4å±¤æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…
# - LESSONS_LEARNED.md ã®çŸ¥è¦‹ã‚’åæ˜   
# - Cloudflare Workers çµ±ä¸€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
# - CIç’°å¢ƒæœ€é©åŒ–ï¼ˆubuntu-latest + chromiumã®ã¿ï¼‰
# - æ®µéšçš„å“è³ªä¿è¨¼ã¨ã‚¨ãƒ©ãƒ¼ã®æ—©æœŸç™ºè¦‹
# - è‡ªå‹•ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆ
# - æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤è‡ªå‹•åŒ–